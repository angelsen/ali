name: tmux
version: 3.0
description: Tmux control with smart parsing and distribution commands
# When this plugin is active
context:
  env_required: TMUX
# Plugin vocabulary
vocabulary:
  verbs: [CREATE, DELETE, LIST, GO, SWITCH, SWAP, RENAME, HORIZONTAL, VERTICAL]
  verb_aliases:
    # Action aliases
    KILL: DELETE
    REMOVE: DELETE
    CLOSE: DELETE
    SELECT: GO
    MOVE: GO
    NAVIGATE: GO
    NEW: CREATE
    MAKE: CREATE
    # Short forms
    N: CREATE
    D: DELETE
    G: GO
    L: LIST
    S: SWITCH
    R: RENAME
    H: HORIZONTAL
    V: VERTICAL
  objects: [PANE, PANES, WINDOW, WINDOWS, SESSION, SESSIONS, ROW, COL]
  directions: [left, right, up, down, above, below]
  clauses: [WITH, FROM, TO, AS]
# Token parsing rules
parsing:
  token_rules:
    # Object detection (first position)
    - match: {position: 0, in_set: objects}
      action: set
      field: object
      transform: upper
    # Directions
    - match: {in_set: directions}
      action: set
      field: direction
      transform: lower
    # Pane numbers for WIDTH/HEIGHT (like "024")
    - match: {regex: "^\\d+$"}
      action: set
      field: panes
    # Target patterns
    - match: {regex: "^[.:][\\w\\d?]*$|^\\?$|^THIS$|^CURRENT$"}
      action: set
      field: target
    # Clauses consume next token
    - match: {in_set: clauses}
      action: consume_next
      field: "{token_lower}"
    # Everything else goes to args
    - match: {else: true}
      action: accumulate
      field: args
# Inference rules
inference:
  rules:
    # Infer object from target prefix
    - when: {target: "^\\.", object: null}
      set: {object: PANE}
    - when: {target: "^:", object: null}
      set: {object: WINDOW}
    - when: {target: "^(THIS|CURRENT)$", object: null}
      set: {object: SESSION}
    # Smart visual selector inference
    - when: {verb: SWAP, target: "^\\.$", with: "^\\?$"}
      transform: {with: ".?"}
    - when: {verb: SWAP, target: "^:$", with: "^\\?$"}
      transform: {with: ":?"}
    # Default ? based on verb
    - when: {verb: GO, target: "^\\?$", object: null}
      set: {object: PANE}
      transform: {target: ".?"}
    - when: {verb: SWITCH, target: "^\\?$", object: null}
      set: {object: SESSION}
    # HORIZONTAL/VERTICAL only work with panes, so ? becomes .?
    - when: {verb: HORIZONTAL, target: "^\\?$"}
      transform: {target: ".?"}
    - when: {verb: VERTICAL, target: "^\\?$"}
      transform: {target: ".?"}
# Field transformations
transformations:
  field_aliases:
    from: target
    to: name
  field_transformations:
    target:
      ".": ""
      ":": ""
      ".THIS": ""
      ":THIS": ""
      "THIS": ""
      "CURRENT": ""
# Expansions
expansions:
  direction:
    type: plugin
    function: expand_direction
  target_flag:
    type: plugin
    function: expand_target_flag
  display_time:
    type: format
    template: "-d 2000"
    default: "-d 2000"
# Commands - now much simpler!
commands:
  # Distribution commands (HORIZONTAL/VERTICAL)
  # Visual selector versions with fraction (most specific first)
  - match: {verb: HORIZONTAL, target: ".?", as: present}
    exec: "tmux display-panes {display_time} \\; command-prompt -p 'Distribute horizontally for panes:' 'run-shell \"ali H %% AS {as}\"'"
  - match: {verb: VERTICAL, target: ".?", as: present}
    exec: "tmux display-panes {display_time} \\; command-prompt -p 'Distribute vertically for panes:' 'run-shell \"ali V %% AS {as}\"'"
  # Visual selector versions without fraction
  - match: {verb: HORIZONTAL, target: ".?"}
    exec: "tmux display-panes {display_time} \\; command-prompt -p 'Distribute horizontally for panes:' 'run-shell \"ali H %%\"'"
  - match: {verb: VERTICAL, target: ".?"}
    exec: "tmux display-panes {display_time} \\; command-prompt -p 'Distribute vertically for panes:' 'run-shell \"ali V %%\"'"
  # Regular versions with values
  - match: {verb: HORIZONTAL, as: present}
    exec: "ali --plugin-script tmux distribute --panes {panes} --dimension width --value {as}"
  - match: {verb: HORIZONTAL}
    exec: "ali --plugin-script tmux distribute --panes {panes} --dimension width"
  - match: {verb: VERTICAL, as: present}
    exec: "ali --plugin-script tmux distribute --panes {panes} --dimension height --value {as}"
  - match: {verb: VERTICAL}
    exec: "ali --plugin-script tmux distribute --panes {panes} --dimension height"
  # All other commands use the dynamic generator
  - match: {else: true}
    type: plugin
    function: generate_command
